<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prague 2026</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px 10px; /* æ¸›å°‘æ‰‹æ©Ÿç‰ˆå·¦å³ padding */
            color: #333;
        }

        /* é ‚éƒ¨å°èˆªåˆ— */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px; /* æ”¾å¯¬æœ€å¤§å¯¬åº¦ä»¥é©æ‡‰å¹³æ¿ */
            margin-bottom: 15px;
        }

        h1 {
            color: #2c3e50;
            margin: 0;
            font-size: clamp(20px, 5vw, 28px); /* éŸ¿æ‡‰å¼å­—é«”å¤§å° */
        }

        .lang-btn {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .subtitle {
            margin-bottom: 20px;
            color: #666;
            text-align: center;
            font-size: 14px;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        button.day-btn {
            padding: 10px 16px;
            font-size: 15px;
            cursor: pointer;
            border: none;
            border-radius: 25px;
            background-color: #e0e0e0;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #555;
            min-width: 70px; /* ç¢ºä¿æŒ‰éˆ•æœ‰æœ€å°å¯¬åº¦ */
        }

        button.day-btn.active {
            background-color: #d35400;
            color: white;
            box-shadow: 0 4px 8px rgba(211, 84, 0, 0.3);
            transform: translateY(-1px);
        }

        button.day-btn:hover:not(.active) {
            background-color: #ccc;
        }

        .canvas-container {
            background: white;
            padding: 0; /* ç§»é™¤ padding è®“ canvas å¡«æ»¿ */
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            position: relative;
            width: 100%;
            max-width: 800px;
            overflow: hidden; /* ç¢ºä¿åœ“è§’ */
        }

        canvas {
            display: block; /* ç§»é™¤ canvas åº•éƒ¨é è¨­é–“éš™ */
            width: 100%;
            /* cursor ç”± JS æ§åˆ¶ */
        }

        .legend {
            margin-top: 20px;
            font-size: 13px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .legend span {
            display: flex;
            align-items: center;
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="header-row">
        <h1>ğŸ‡¨ğŸ‡¿ <span id="main-title">å¸ƒæ‹‰æ ¼ 4å¤©3å¤œ</span></h1>
        <button class="lang-btn" onclick="toggleLanguage()">EN / ä¸­æ–‡</button>
    </div>
    <p class="subtitle" id="sub-title">è¼•é¬†æ‹ç…§ãƒ»ç¶²ç´…æ‰“å¡ãƒ»ç´ é£Ÿå‹å–„</p>

    <div class="controls">
        <button onclick="loadDay(1)" id="btn1" class="day-btn active">Day 1</button>
        <button onclick="loadDay(2)" id="btn2" class="day-btn">Day 2</button>
        <button onclick="loadDay(3)" id="btn3" class="day-btn">Day 3</button>
        <button onclick="loadDay(4)" id="btn4" class="day-btn">Day 4</button>
    </div>

    <div class="canvas-container" id="canvasContainer">
        <canvas id="tripCanvas"></canvas>
    </div>

    <div class="legend">
        <span id="leg-sight"><span class="dot" style="background:#d35400"></span> æ™¯é» (Sight)</span>
        <span id="leg-food"><span class="dot" style="background:#27ae60"></span> é¤é£² (Food)</span>
        <span id="leg-transport"><span class="dot" style="background:#3498db"></span> äº¤é€š (Transport)</span>
    </div>

    <script>
        const canvas = document.getElementById('tripCanvas');
        const container = document.getElementById('canvasContainer');
        const ctx = canvas.getContext('2d');
        let currentDay = 1;
        let currentLang = 'zh';
        let hitRegions = [];
        let imageCache = {}; // ç·©å­˜åœ–ç‰‡ç‰©ä»¶

        // UI æ–‡æœ¬
        const uiText = {
            zh: {
                mainTitle: "å¸ƒæ‹‰æ ¼ 4å¤©3å¤œ",
                subTitle: "è¼•é¬†æ‹ç…§ãƒ»ç¶²ç´…æ‰“å¡ãƒ»ç´ é£Ÿå‹å–„",
                dayNames: ["Day 1: èˆŠåŸç«¥è©±", "Day 2: åŸå ¡ç¾æ™¯", "Day 3: æ²³å²¸æ¼«éŠ", "Day 4: æ‚ é–’è¿”ç¨‹"],
                legend: ["æ™¯é» (Sight)", "é¤é£² (Food)", "äº¤é€š (Transport)"],
                btnMap: "åœ°åœ–",
                btnRoute: "è·¯ç·š"
            },
            en: {
                mainTitle: "Prague 4 Days",
                subTitle: "Relaxing â€¢ Instagram Spots â€¢ Veg Friendly",
                dayNames: ["Day 1: Old Town", "Day 2: Castle View", "Day 3: River Walk", "Day 4: Departure"],
                legend: ["Sight", "Food", "Transport"],
                btnMap: "Map",
                btnRoute: "Route"
            }
        };

        // è¡Œç¨‹æ•¸æ“š (åŠ å…¥åœ–ç‰‡ URL)
        // ä½¿ç”¨ Unsplash Source ä½œç‚ºç¤ºç¯„åœ–ç‰‡
        const itineraryData = {
            1: {
                title: { zh: "Day 1: èˆŠåŸå€çš„æµªæ¼«èˆ‡å¤œæ™¯", en: "Day 1: Romance of Old Town" },
                stops: [
                    { time: "14:00", title: {zh: "ç“¦èŒ¨æ‹‰å¤«å»£å ´", en: "Wenceslas Square"}, desc: {zh: "å¸ƒæ‹‰æ ¼çš„å•†æ¥­å¿ƒè‡Ÿï¼Œèåˆæ­·å²å»ºç¯‰èˆ‡ç¾ä»£æ´»åŠ›ã€‚", en: "Bustling city hub, history meets modern vibes."}, type: "sight", query: "Wenceslas Square Prague", img: "https://images.unsplash.com/photo-1592960761633-8557b63f533a?w=160&h=160&fit=crop" },
                    { time: "15:00", title: {zh: "ç«è—¥å¡” & å¸‚æ°‘æœƒé¤¨", en: "Powder Tower"}, desc: {zh: "å“¥å¾·å¼åŸé–€åœ°æ¨™ï¼Œæ¬£è³æ–°è—è¡“é¢¨æ ¼çš„ç²¾ç·»ç´°ç¯€ã€‚", en: "Gothic gate landmark, admire Art Nouveau details."}, type: "sight", query: "Powder Tower Prague", img: "https://images.unsplash.com/photo-1541849546-216549ae216d?w=160&h=160&fit=crop" },
                    { time: "16:00", title: {zh: "èˆŠåŸå»£å ´ & ç…™å›ªæ²", en: "Old Town Square"}, desc: {zh: "å¿…çœ‹æ•´é»å¤©æ–‡é˜ã€‚æ¨è–¦è©¦è©¦è·¯é‚Šæ”¤çš„è‚‰æ¡‚ç…™å›ªæ²ã€‚", en: "Watch the Clock. Try the local cinnamon TrdelnÃ­k."}, type: "sight", query: "Old Town Square Prague", img: "https://images.unsplash.com/photo-1515488764276-beab7607c1e6?w=160&h=160&fit=crop" },
                    { time: "18:00", title: {zh: "æŸ¥ç†å¤§æ©‹ (æ—¥è½)", en: "Charles Bridge (Sunset)"}, desc: {zh: "30å°Šè–å¾’é›•åƒé–“æ¼«æ­¥ï¼Œæ—¥è½æ™‚åˆ†çš„æ²³æ™¯æœ€è¿·äººã€‚", en: "Walk among 30 statues, best river views at sunset."}, type: "sight", query: "Charles Bridge Prague", img: "https://images.unsplash.com/photo-1559523118-2b842915822e?w=160&h=160&fit=crop" },
                    { time: "19:30", title: {zh: "æ™šé¤: Maitrea", en: "Dinner: Maitrea"}, desc: {zh: "ç¦ªæ„é¢¨ç´ é£Ÿã€‚æ¨è–¦ï¼šè€å¸ƒæ‹‰æ ¼å‚³çµ±ç´ é£Ÿæ‹¼ç›¤ã€‚", en: "Zen style. Rec: Old Prague Traditional Vegan Plate."}, type: "food", query: "Maitrea restaurace Prague", img: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=160&h=160&fit=crop" }
                ]
            },
            2: {
                title: { zh: "Day 2: åŸå ¡å€èˆ‡æ–‡é’ç‰†", en: "Day 2: Castle & Lennon Wall" },
                stops: [
                    { time: "10:00", title: {zh: "ä½©ç‰¹ä»»å±±çºœè»Š", en: "PetÅ™Ã­n Funicular"}, desc: {zh: "æ­ä¹˜å¾©å¤çºœè»Šä¸Šå±±ï¼Œä¿¯ç°å¸ƒæ‹‰æ ¼ç´…å±‹é ‚å…¨æ™¯ã€‚", en: "Ride funicular up the hill for panoramic roof views."}, type: "transport", query: "Petrin Funicular Prague", img: "https://images.unsplash.com/photo-1517524206127-48bbd363f3d7?w=160&h=160&fit=crop" },
                    { time: "12:30", title: {zh: "åˆé¤: Vegan's Prague", en: "Lunch: Vegan's Prague"}, desc: {zh: "åŸå ¡ä¸‹çµ•ç¾æ™¯è§€ã€‚æ¨è–¦ï¼šç”œèœæ ¹ç´ é£Ÿæ¼¢å ¡ã€‚", en: "Castle view. Rec: Beetroot Burger."}, type: "food", query: "Vegan's Prague", img: "https://images.unsplash.com/photo-1520201163981-8cc95007dd2a?w=160&h=160&fit=crop" },
                    { time: "14:00", title: {zh: "å¸ƒæ‹‰æ ¼åŸå ¡", en: "Prague Castle"}, desc: {zh: "ä¸–ç•Œæœ€å¤§å¤å ¡ç¾¤ï¼Œå¿…è¨ªèŠåš´çš„è–ç¶­ç‰¹å¤§æ•™å ‚ã€‚", en: "Largest castle complex, visit St. Vitus Cathedral."}, type: "sight", query: "Prague Castle", img: "https://images.unsplash.com/photo-1549528623-64491972f071?w=160&h=160&fit=crop" },
                    { time: "16:00", title: {zh: "å°åŸå€æ¼«æ­¥", en: "Lesser Town Stroll"}, desc: {zh: "æ²¿æ¶…é­¯é”è¡—ä¸‹å¡ï¼Œæ¢ç´¢å·´æ´›å…‹å¼å··å¼„å°åº—ã€‚", en: "Walk down Nerudova St., explore Baroque alleys."}, type: "transport", query: "MalÃ¡ Strana Prague", img: "https://images.unsplash.com/photo-1542385151-546473663674?w=160&h=160&fit=crop" },
                    { time: "17:30", title: {zh: "åˆ—å„‚ç‰†", en: "Lennon Wall"}, desc: {zh: "è±¡å¾µæ„›èˆ‡å’Œå¹³çš„å½©è‰²å¡—é´‰ç‰†ï¼Œæ–‡é’å¿…æ‹ã€‚", en: "Colorful graffiti wall symbolizing love and peace."}, type: "sight", query: "Lennon Wall Prague", img: "https://images.unsplash.com/photo-1563292787-8f5b4d732c53?w=160&h=160&fit=crop" },
                    { time: "19:00", title: {zh: "æ™šé¤: LehkÃ¡ Hlava", en: "Dinner: LehkÃ¡ Hlava"}, desc: {zh: "å¤¢å¹»æ˜Ÿç©ºæˆ¿ã€‚æ¨è–¦ï¼šå¢¨è¥¿å“¥é»‘è±†é£¯èˆ‡ç‰ç±³ç‰‡ã€‚", en: "Starry ceiling. Rec: Mexican Bowl with Nachos."}, type: "food", query: "LehkÃ¡ Hlava Prague", img: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=160&h=160&fit=crop" }
                ]
            },
            3: {
                title: { zh: "Day 3: ä¼çˆ¾å¡”ç“¦æ²³èˆ‡ç¾ä»£è—è¡“", en: "Day 3: Vltava River & Art" },
                stops: [
                    { time: "10:30", title: {zh: "è·³èˆçš„æˆ¿å­", en: "Dancing House"}, desc: {zh: "å‰è¡›è§£æ§‹ä¸»ç¾©å»ºç¯‰ï¼Œç”±Gehryè¨­è¨ˆçš„æ‰­æ›²ä¹‹ç¾ã€‚", en: "Deconstructivist icon designed by Frank Gehry."}, type: "sight", query: "Dancing House Prague", img: "https://images.unsplash.com/photo-1457816049753-15793081b7d5?w=160&h=160&fit=crop" },
                    { time: "13:00", title: {zh: "åˆé¤: æ²³å²¸å¸‚é›†", en: "Lunch: River Market"}, desc: {zh: "é€±å…­è¾²å¤«å¸‚é›†ã€‚æ¨è–¦ï¼šçƒ¤èµ·å¸ä¸‰æ˜æ²»èˆ‡æ–°é®®è“æœã€‚", en: "Farmers market. Rec: Grilled Cheese & fresh berries."}, type: "food", query: "Naplavka Farmers Market", img: "https://images.unsplash.com/photo-1488459716781-31db52582fe9?w=160&h=160&fit=crop" },
                    { time: "14:30", title: {zh: "ç§Ÿå€Ÿè…³è¸èˆ¹", en: "Pedal Boat Rental"}, desc: {zh: "è¸©è‘—å¤©éµèˆ¹åˆ°æ²³ä¸­å¤®ï¼Œç”¨ä¸åŒè¦–è§’çœ‹æŸ¥ç†å¤§æ©‹ã€‚", en: "Rent a swan boat to view the bridge from the water."}, type: "activity", query: "Slovansky Island Boat Rental", img: "https://images.unsplash.com/photo-1621257916849-c09a8eb76e5d?w=160&h=160&fit=crop" },
                    { time: "16:30", title: {zh: "Na PÅ™Ã­kopÄ› è³¼ç‰©è¡—", en: "Na PÅ™Ã­kopÄ› Shopping"}, desc: {zh: "å¸ƒæ‹‰æ ¼çš„é¦™æ¦­å¤§é“ï¼Œè³¼è²·ä¿é¤Šå“èˆ‡æ°´æ™¶ç´€å¿µå“ã€‚", en: "Prague's main boulevard for shopping and souvenirs."}, type: "activity", query: "Na Prikope Prague", img: "https://images.unsplash.com/photo-1481438549483-387c513304be?w=160&h=160&fit=crop" },
                    { time: "19:00", title: {zh: "æ™šé¤: EtnosvÄ›t", en: "Dinner: EtnosvÄ›t"}, desc: {zh: "ç²çç„¡æ•¸çš„åœ‹éš›ç´ é£Ÿã€‚æ¨è–¦ï¼šç´”ç´ éŸƒé¼ç‰›æ’ã€‚", en: "Award-winning. Rec: Vegan Tartare & Risotto."}, type: "food", query: "Etnosvet Prague", img: "https://images.unsplash.com/photo-1540420773420-3366772f4999?w=160&h=160&fit=crop" },
                    { time: "21:00", title: {zh: "é…’å§: Hemingway", en: "Bar: Hemingway"}, desc: {zh: "é ‚ç´šèª¿é…’é«”é©—ï¼Œäº¦æä¾›å¤šæ¬¾ç²¾ç·»ç„¡é…’ç²¾ç‰¹èª¿ã€‚", en: "Top-tier cocktails, also offers great Mocktails."}, type: "activity", query: "Hemingway Bar Prague", img: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=160&h=160&fit=crop" }
                ]
            },
            4: {
                title: { zh: "Day 4: æ—©åˆé¤èˆ‡å‘Šåˆ¥", en: "Day 4: Brunch & Farewell" },
                stops: [
                    { time: "10:00", title: {zh: "æ—©åˆé¤: CafÃ© Savoy", en: "Brunch: CafÃ© Savoy"}, desc: {zh: "æ–°æ–‡è—å¾©èˆˆé¢¨æ ¼ã€‚æ¨è–¦ï¼šæ³•å¼åå¸èˆ‡ç†±å·§å…‹åŠ›ã€‚", en: "Neo-Renaissance style. Rec: French Toast & Cocoa."}, type: "food", query: "Cafe Savoy Prague", img: "https://images.unsplash.com/photo-1497935586351-b67a49e012bf?w=160&h=160&fit=crop" },
                    { time: "11:30", title: {zh: "å“ˆç¶­çˆ¾å¸‚é›†", en: "Havel's Market"}, desc: {zh: "ç™¾å¹´éœ²å¤©å¸‚é›†ï¼Œè³¼è²·åœ¨åœ°èœ‚èœœã€æ°´æœèˆ‡æœ¨å¶ã€‚", en: "Historic open-air market for honey, fruit & puppets."}, type: "sight", query: "Havelske trziste Prague", img: "https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=160&h=160&fit=crop" },
                    { time: "13:00", title: {zh: "å‰å¾€æ©Ÿå ´", en: "To Airport"}, desc: {zh: "å»ºè­°é ç•™3å°æ™‚è¾¦ç†é€€ç¨…ã€‚æ­ä¹˜ Bolt æœ€æ–¹ä¾¿ã€‚", en: "Allow 3 hrs for tax refund. Take Bolt for comfort."}, type: "transport", query: "Vaclav Havel Airport Prague", img: "https://images.unsplash.com/photo-1436491865332-7a615109cc05?w=160&h=160&fit=crop" }
                ]
            }
        };

        // --- è¼”åŠ©åŠŸèƒ½ï¼šé è¼‰åœ–ç‰‡ ---
        function preloadImages(day) {
            const stops = itineraryData[day].stops;
            stops.forEach(stop => {
                if (stop.img && !imageCache[stop.img]) {
                    const img = new Image();
                    img.src = stop.img;
                    img.onload = () => {
                        // åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œé‡ç¹ª (å¦‚æœé‚„åœ¨åŒä¸€å¤©)
                        if (currentDay === day) drawItinerary(day);
                    };
                    imageCache[stop.img] = img;
                }
            });
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateStaticText();
            drawItinerary(currentDay);
        }

        function updateStaticText() {
            const t = uiText[currentLang];
            document.getElementById('main-title').innerText = t.mainTitle;
            document.getElementById('sub-title').innerText = t.subTitle;
            document.getElementById('btn1').innerText = t.dayNames[0].split(':')[0];
            
            document.getElementById('leg-sight').innerHTML = `<span class="dot" style="background:#d35400"></span> ${t.legend[0]}`;
            document.getElementById('leg-food').innerHTML = `<span class="dot" style="background:#27ae60"></span> ${t.legend[1]}`;
            document.getElementById('leg-transport').innerHTML = `<span class="dot" style="background:#3498db"></span> ${t.legend[2]}`;
        }

        // --- æ ¸å¿ƒï¼šæ–‡å­—æ›è¡Œè¨ˆç®— ---
        function wrapText(context, text, x, y, maxWidth, lineHeight, simulate = false) {
            const words = text.split(''); // ä¸­æ–‡é€å­—åˆ‡åˆ†
            let line = '';
            let lineCount = 0;
            let currentY = y;

            // è‹±æ–‡å–®è©åˆä½µé‚è¼¯ç°¡å–®è™•ç† (å„ªåŒ–ï¼šå¦‚æœé‡åˆ°ç©ºæ ¼å‰‡ç•¶ä½œå–®è©)
            // é€™è£¡ç‚ºäº†ä¸­è‹±æ–‡æ··æ’ç°¡å–®ï¼Œæ¡ç”¨é€å­—æª¢æŸ¥ + å¯¬åº¦åˆ¤æ–·
            // è‹¥éœ€æ›´åš´è¬¹è‹±æ–‡æ›è¡Œå¯æ”¹ç”¨ space split
            
            for (let n = 0; n < words.length; n++) {
                // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœæ˜¯è‹±æ–‡å–®è©ï¼Œå˜—è©¦æ•´è©åˆä½µ (ç°¡æ˜“ç‰ˆ)
                let testLine = line + words[n];
                let metrics = context.measureText(testLine);
                let testWidth = metrics.width;
                
                if (testWidth > maxWidth && n > 0) {
                    if (!simulate) context.fillText(line, x, currentY);
                    line = words[n];
                    currentY += lineHeight;
                    lineCount++;
                } else {
                    line = testLine;
                }
            }
            if (!simulate) context.fillText(line, x, currentY);
            lineCount++;
            return { lineCount, height: lineCount * lineHeight };
        }

        function drawItinerary(day) {
            // 1. å–å¾—å®¹å™¨å¯¬åº¦ï¼Œè¨­å®š Canvas å°ºå¯¸
            const width = container.clientWidth;
            // é¿å…å¯¬åº¦ 0 çš„éŒ¯èª¤
            if (width === 0) return; 

            // è¨­å®šéŸ¿æ‡‰å¼åƒæ•¸
            const isMobile = width < 500;
            const timelineX = isMobile ? 30 : 50; // æ™‚é–“è»¸ç·š X åº§æ¨™
            const contentStartX = isMobile ? 60 : 100; // å…§å®¹èµ·å§‹ X åº§æ¨™
            const cardPadding = 15;
            const imgSize = isMobile ? 60 : 80;
            const cardMinHeight = imgSize + 30; // ç¢ºä¿é«˜åº¦è‡³å°‘åŒ…ä½åœ–ç‰‡
            
            const data = itineraryData[day];
            const stops = data.stops;

            // 2. é è¨ˆç®—é«˜åº¦ (å› ç‚º Canvas é«˜åº¦æ”¹è®Šæœƒæ¸…ç©ºå…§å®¹ï¼Œå¿…é ˆå…ˆç®—)
            ctx.font = '14px -apple-system, BlinkMacSystemFont, Arial'; // è¨­å®šå­—é«”ä»¥æ¸¬é‡
            let totalHeight = 80; // æ¨™é¡Œå€é«˜åº¦
            const cardGap = 20;
            const cardWidth = width - contentStartX - 20; // 20px å³é‚Šè·
            
            // å„²å­˜æ¯å€‹å¡ç‰‡çš„é«˜åº¦ä»¥ä¾¿ç¹ªè£½
            const stopHeights = stops.map(stop => {
                // è¨ˆç®—æ–‡å­—æ‰€éœ€é«˜åº¦
                // æ¨™é¡Œé«˜åº¦ + é–“è· + æè¿°é«˜åº¦ + æŒ‰éˆ•é«˜åº¦
                const titleH = 24; 
                const btnH = 40; 
                // æè¿°æ–‡å­—å¯¬åº¦ï¼šæ‰£é™¤åœ–ç‰‡å¯¬åº¦ (å¦‚æœæœ‰çš„è©±)
                const textWidth = cardWidth - (cardPadding * 3) - imgSize;
                const descMetrics = wrapText(ctx, stop.desc[currentLang], 0, 0, textWidth, 18, true);
                
                let h = cardPadding + titleH + 5 + descMetrics.height + 10 + btnH + cardPadding;
                return Math.max(h, cardMinHeight); // ç¢ºä¿ä¸å°æ–¼åœ–ç‰‡é«˜åº¦
            });

            const contentHeight = stopHeights.reduce((a, b) => a + b + cardGap, 0);
            canvas.width = width;
            canvas.height = totalHeight + contentHeight + 50; // åŠ ä¸Šåº•éƒ¨ç·©è¡

            // 3. é–‹å§‹ç¹ªè£½
            hitRegions = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // èƒŒæ™¯æ¢ç´‹è£é£¾
            ctx.strokeStyle = '#f8f8f8';
            ctx.lineWidth = 1;
            for(let i=0; i<canvas.width; i+=30) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }

            // æ¨™é¡Œ
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont, Arial';
            ctx.textAlign = 'left';
            ctx.fillText(data.title[currentLang], 20, 45);

            // ç¹ªè£½æ™‚é–“è»¸ç·š
            ctx.beginPath();
            ctx.moveTo(timelineX, 80);
            ctx.lineTo(timelineX, canvas.height - 40);
            ctx.strokeStyle = '#bdc3c7';
            ctx.lineWidth = 4;
            ctx.setLineDash([10, 5]);
            ctx.stroke();
            ctx.setLineDash([]);

            let currentY = 80;

            stops.forEach((stop, index) => {
                const h = stopHeights[index];
                const cardX = contentStartX;
                const cardY = currentY;
                const cardW = cardWidth;
                
                // --- ç¹ªè£½æ™‚é–“è»¸ç¯€é» ---
                const nodeY = cardY + 25; // ç¯€é»ç´„åœ¨å¡ç‰‡ä¸Šæ–¹
                ctx.beginPath();
                ctx.arc(timelineX, nodeY, 12, 0, 2 * Math.PI);
                
                // é¡è‰²é‚è¼¯
                let color = '#d35400'; // Sight
                if (stop.type === 'food') color = '#27ae60';
                if (stop.type === 'transport' || stop.type === 'activity') color = '#3498db';
                
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();

                // ç¹ªè£½æ™‚é–“ (æ‰‹æ©Ÿç‰ˆæ”¾ç¯€é»ä¸Šæ–¹ï¼Œæ¡Œé¢ç‰ˆæ”¾ç¯€é»æ—é‚Š?) 
                // ç‚ºäº†ç°¡åŒ– RWDï¼Œçµ±ä¸€æ”¾åœ¨ç¯€é»æ—é‚Šï¼Œä½†èª¿æ•´å°é½Š
                ctx.fillStyle = '#7f8c8d';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                // åœ¨åœ“åœˆå…§ç•« Icon æˆ–æ˜¯æ™‚é–“? 
                // é€™è£¡æ”¹ç‚ºï¼šæ™‚é–“å¯«åœ¨å¡ç‰‡å·¦ä¸Šè§’æˆ–ç¯€é»æ—é‚Š
                // ç‚ºäº†æ‰‹æ©Ÿé–±è®€ï¼Œå°‡æ™‚é–“ç•«åœ¨ç¯€é»ä¸Šæ–¹
                ctx.fillStyle = '#666';
                ctx.font = 'bold 13px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(stop.time, timelineX, nodeY - 18);

                // --- ç¹ªè£½å¡ç‰‡æœ¬é«” ---
                // é™°å½±
                ctx.shadowColor = 'rgba(0,0,0,0.08)';
                ctx.shadowBlur = 15;
                ctx.shadowOffsetY = 4;
                
                ctx.fillStyle = 'white';
                // åœ“è§’çŸ©å½¢
                roundRect(ctx, cardX, cardY, cardW, h, 12);
                ctx.fill();
                
                // å·¦å´è‰²æ¢
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.roundRect(cardX, cardY, 6, h, [12, 0, 0, 12]);
                ctx.fill();

                ctx.shadowColor = 'transparent'; // é‡ç½®é™°å½±

                // --- å¡ç‰‡å…§å®¹ ---
                const textStartX = cardX + 15 + 6;
                const textWidth = cardW - (cardPadding * 3) - imgSize;

                // æ¨™é¡Œ
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, Arial';
                ctx.textAlign = 'left';
                ctx.fillText(stop.title[currentLang], textStartX, cardY + 30);

                // æè¿° (è‡ªå‹•æ›è¡Œ)
                ctx.fillStyle = '#7f8c8d';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, Arial';
                wrapText(ctx, stop.desc[currentLang], textStartX, cardY + 55, textWidth, 20);

                // --- ç¹ªè£½åœ–ç‰‡ ---
                if (stop.img && imageCache[stop.img]) {
                    const img = imageCache[stop.img];
                    const imgX = cardX + cardW - imgSize - 15;
                    const imgY = cardY + 15;
                    
                    ctx.save();
                    // ç¹ªè£½åœ“è§’åœ–ç‰‡è·¯å¾‘
                    roundRect(ctx, imgX, imgY, imgSize, imgSize, 8);
                    ctx.clip();
                    try {
                        ctx.drawImage(img, imgX, imgY, imgSize, imgSize);
                    } catch(e) { /* ignore load error */ }
                    ctx.restore();
                } else {
                    // Placeholder box if image not loaded
                    const imgX = cardX + cardW - imgSize - 15;
                    const imgY = cardY + 15;
                    ctx.fillStyle = '#eee';
                    roundRect(ctx, imgX, imgY, imgSize, imgSize, 8);
                    ctx.fill();
                    ctx.fillStyle = '#ccc';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('ğŸ“·', imgX + imgSize/2, imgY + imgSize/2 + 7);
                }

                // --- æŒ‰éˆ•å€åŸŸ ---
                const btnY = cardY + h - 35; // é åº•éƒ¨
                const btnH = 28;
                const btnW = 70;
                
                // åœ°åœ–æŒ‰éˆ•
                const btnMapX = textStartX;
                drawButton(ctx, btnMapX, btnY, btnW, btnH, uiText[currentLang].btnMap, '#f0f2f5', '#2c3e50');
                hitRegions.push({
                    x: btnMapX, y: btnY, w: btnW, h: btnH,
                    type: 'link',
                    url: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.query)}`
                });

                // è·¯ç·šæŒ‰éˆ•
                const btnRouteX = btnMapX + btnW + 10;
                drawButton(ctx, btnRouteX, btnY, btnW, btnH, uiText[currentLang].btnRoute, '#3498db', 'white');
                hitRegions.push({
                    x: btnRouteX, y: btnY, w: btnW, h: btnH,
                    type: 'link',
                    url: `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(stop.query)}`
                });

                // æ›´æ–° Y åº§æ¨™çµ¦ä¸‹ä¸€å€‹å¡ç‰‡
                currentY += h + cardGap;
            });
        }

        // è¼”åŠ©ï¼šåœ“è§’çŸ©å½¢è·¯å¾‘
        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            if (ctx.roundRect) {
                ctx.roundRect(x, y, w, h, r);
            } else {
                // Fallback for older browsers
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + w - r, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                ctx.lineTo(x + w, y + h - r);
                ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                ctx.lineTo(x + r, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
            }
            ctx.closePath();
        }

        function drawButton(ctx, x, y, w, h, text, bgColor, textColor) {
            ctx.fillStyle = bgColor;
            roundRect(ctx, x, y, w, h, 14); // Pill shape
            ctx.fill();
            
            ctx.fillStyle = textColor;
            ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, x + w/2, y + h/2 + 5);
        }

        function loadDay(day) {
            currentDay = day;
            
            // æ›´æ–° UI æŒ‰éˆ•ç‹€æ…‹
            for(let i=1; i<=4; i++) {
                const btn = document.getElementById('btn'+i);
                if(i === day) btn.classList.add('active');
                else btn.classList.remove('active');
            }

            // é è¼‰åœ–ç‰‡ä¸¦ç¹ªè£½
            preloadImages(day);
            drawItinerary(day);
        }

        // äº‹ä»¶ç›£è½
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            // è™•ç† canvas å¯èƒ½è¢« CSS ç¸®æ”¾çš„æƒ…æ³ (é›–ç„¶é€™è£¡æˆ‘å€‘è¨­ç‚º 1:1)
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            hitRegions.forEach(region => {
                if (mouseX >= region.x && mouseX <= region.x + region.w &&
                    mouseY >= region.y && mouseY <= region.y + region.h) {
                    if (region.type === 'link') {
                        window.open(region.url, '_blank');
                    }
                }
            });
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            let isHovering = false;
            hitRegions.forEach(region => {
                if (mouseX >= region.x && mouseX <= region.x + region.w &&
                    mouseY >= region.y && mouseY <= region.y + region.h) {
                    isHovering = true;
                }
            });
            canvas.style.cursor = isHovering ? 'pointer' : 'default';
        });

        // RWD æ ¸å¿ƒï¼šç›£è½è¦–çª—å¤§å°æ”¹è®Š
        let resizeTimeout;
        window.addEventListener('resize', () => {
            // Debounce é¿å…é »ç¹é‡ç¹ª
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                drawItinerary(currentDay);
            }, 100);
        });

        // åˆå§‹åŠ è¼‰
        loadDay(1);

    </script>
</body>
</html>
